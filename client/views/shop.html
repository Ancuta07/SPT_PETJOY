<!DOCTYPE html>
<html lang="ro">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Magazin Online - Clinica VeterinarÄƒ</title>
    <meta
      name="description"
      content="Magazin online cu produse pentru animale. AfiÈ™are disponibilitate per magazin È™i cumpÄƒrÄƒturi online. Transport gratuit peste 100 lei."
    />
    <link rel="stylesheet" href="../styles/shop.css" />
  </head>

  <body>
    <section class="header">
      <nav>
        <div class="nav-links">
          <ul>
            <li><a href="index.html">MENIU</a></li>
            <li><a href="despre.html">DESPRE NOI</a></li>
            <li><a href="contact.html">CONTACTE</a></li>
            <li><a href="shop.html">SHOP</a></li>
            <li id="authButton">
              <a href="autentificare.html" title="Autentificare">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                  <polyline points="16 17 21 12 16 7" />
                  <line x1="21" y1="12" x2="9" y2="12" />
                </svg>
              </a>
            </li>
            <li id="profileButton" style="display: none">
              <a href="meniu.html" title="Profilul meu">ðŸ‘¤</a>
            </li>
          </ul>
        </div>
      </nav>
    </section>

    <div class="wrap">
      <header>
        <div class="brand">
          <div class="logo">
            <img src="../images/shop1.jpeg" />
          </div>

          <div>
            <h1>Magazin Online PetJoy</h1>
            <div class="lead">
              Transport gratuit la comenzi â‰¥ <strong>100 lei</strong> â€¢ Ridicare
              din magazine disponibile: BraÈ™ov Â· ConstanÈ›a Â· Sibiu
            </div>
          </div>
        </div>
      </header>

      <main class="main">
        <aside class="sidebar">
          <div class="categories">
            <h3>Categorii</h3>
            <div class="category active" data-category="toate">Toate</div>
            <div class="category" data-category="uscata">MÃ¢ncare uscatÄƒ</div>
            <div class="category" data-category="umeda">MÃ¢ncare umedÄƒ</div>
            <div class="category" data-category="accesorii">Accesorii</div>
            <div class="category" data-category="asternut">
              AÈ™ternut igienic
            </div>
          </div>
        </aside>

        <section class="products-wrap">
          <div class="filters">
            <input type="text" class="search" placeholder="CautÄƒ produse..." />
          </div>
          <div class="grid" id="productGrid"></div>
        </section>

        <aside class="cart">
          <h3>CoÈ™ de cumpÄƒrÄƒturi</h3>
          <div class="cart-list" id="cartList"></div>
          <div class="total">Total: <span id="totalPrice">0</span> lei</div>
          <div class="shipping-note" id="shippingNote"></div>
          <button class="btn btn-primary" id="checkoutBtn">
            FinalizeazÄƒ comanda
          </button>
        </aside>
      </main>

      <footer>Â© 2025 Clinica VeterinarÄƒ - Toate drepturile rezervate.</footer>
    </div>

    <script>
      /**
       * FALLBACK: produse hardcodate (ca sÄƒ nu pierzi nimic).
       * DacÄƒ backend-ul nu merge / nu rÄƒspunde, le folosim pe astea.
       */
      const fallbackProducts = [
        {
          id: 1,
          categorie: "uscata",
          nume: "Hrana uscata pisici Whiskas",
          pret: 45,
          stoc: 999,
          imageUrl: "../images/w.jpeg",
          descriere: "",
        },
        {
          id: 2,
          categorie: "umeda",
          nume: "Conserva umeda Royal Canin",
          pret: 22,
          stoc: 999,
          imageUrl: "../images/conserva_royal.jpeg",
          descriere: "",
        },
        {
          id: 3,
          categorie: "accesorii",
          nume: "Jucarie soricel pentru pisici",
          pret: 15,
          stoc: 999,
          imageUrl: "../images/jucarie.jpeg",
          descriere: "",
        },
        {
          id: 4,
          categorie: "asternut",
          nume: "Asternut igienic",
          pret: 39,
          stoc: 999,
          imageUrl: "../images/nisip.jpeg",
          descriere: "",
        },
        {
          id: 5,
          categorie: "uscata",
          nume: "Hrana uscata caini Pedigree",
          pret: 110,
          stoc: 999,
          imageUrl: "../images/p.jpeg",
          descriere: "",
        },
        {
          id: 6,
          categorie: "accesorii",
          nume: "Lesa reglabila",
          pret: 49,
          stoc: 999,
          imageUrl: "../images/ham.jpeg",
          descriere: "",
        },
        {
          id: 7,
          categorie: "umeda",
          nume: "Conserva pisici",
          pret: 30,
          stoc: 999,
          imageUrl: "../images/conserva_pisici.jpeg",
          descriere: "",
        },
        {
          id: 8,
          categorie: "asternut",
          nume: "Nisip parfumat pisici",
          pret: 55,
          stoc: 999,
          imageUrl: "../images/nisip_parfumat.jpeg",
          descriere: "",
        },
      ];

      /**
       * Lista realÄƒ de produse (ideal vine din backend).
       * DacÄƒ nu reuÈ™im sÄƒ Ã®ncÄƒrcÄƒm din backend, punem fallbackProducts.
       */
      let products = [];

      const grid = document.getElementById("productGrid");
      const cartList = document.getElementById("cartList");
      const totalPrice = document.getElementById("totalPrice");
      const shippingNote = document.getElementById("shippingNote");

      // Ã®n coÈ™ salvÄƒm minimul ca sÄƒ nu depindem de structura backend
      let cart = JSON.parse(localStorage.getItem("cart") || "[]");

      /**
       * ÃŽncearcÄƒ sÄƒ ia produsele din backend.
       * DacÄƒ backend nu merge / e gol / dÄƒ eroare => fallbackProducts.
       */
      async function loadProducts() {
        try {
          const res = await fetch("/api/products");
          if (!res.ok) throw new Error("Backend error: " + res.status);

          const data = await res.json();

          // dacÄƒ backend rÄƒspunde dar e gol, folosim fallback (ca sÄƒ ai UI populat)
          if (!Array.isArray(data) || data.length === 0) {
            products = fallbackProducts;
          } else {
            products = data;
          }
        } catch (err) {
          console.warn("Backend indisponibil, folosesc fallbackProducts.", err);
          products = fallbackProducts;
        }

        const active =
          document.querySelector(".category.active")?.dataset.category ||
          "toate";
        const search = document.querySelector(".search").value;
        renderProducts(active, search);
      }

      function renderProducts(filter = "toate", search = "") {
        grid.innerHTML = "";

        const f = (filter || "toate").toLowerCase();
        const s = (search || "").toLowerCase();

        products
          .filter((p) => {
            const categorie = (p.categorie || "").toLowerCase();
            const nume = (p.nume || "").toLowerCase();

            const matchCategory = f === "toate" || categorie === f;
            const matchSearch = nume.includes(s);

            return matchCategory && matchSearch;
          })
          .forEach((p) => {
            const card = document.createElement("div");
            card.className = "card";

            const img = p.imageUrl || "../images/shop.jpeg";
            const nume = p.nume || "Produs";
            const descriere = p.descriere || "";
            const pret = p.pret ?? 0;
            const stoc = p.stoc ?? 0;

            card.innerHTML = `
              <img src="${img}" alt="${nume}" class="prod-img">
              <div class="prod-title">${nume}</div>
              ${descriere ? `<div class="prod-desc">${descriere}</div>` : ``}
              <div class="price">${pret} lei</div>
              <div class="stores" style="${
                stoc <= 0 ? "color: red; font-weight: bold;" : ""
              }">Stoc: ${stoc}</div>
              <button class="btn btn-primary" onclick="addToCart(${p.id})" ${
              stoc <= 0 ? "disabled" : ""
            }>
                ${stoc <= 0 ? "Stoc epuizat" : "AdaugÄƒ Ã®n coÈ™"}
              </button>
            `;

            grid.appendChild(card);
          });
      }

      function addToCart(id) {
        const prod = products.find((p) => p.id === id);
        if (!prod) return;

        if ((prod.stoc ?? 0) <= 0) {
          alert("Produsul nu mai este Ã®n stoc.");
          return;
        }

        const item = cart.find((i) => i.id === id);
        if (item) {
          item.qty++;
        } else {
          cart.push({
            id: prod.id,
            nume: prod.nume,
            pret: prod.pret,
            imageUrl: prod.imageUrl,
            qty: 1,
          });
        }
        updateCart();
      }

      function updateCart() {
        cartList.innerHTML = "";
        let total = 0;

        cart.forEach((i) => {
          total += (i.pret || 0) * i.qty;

          const row = document.createElement("div");
          row.className = "cart-item";
          row.innerHTML = `
            <div>${i.nume}</div>
            <div class="qty">
              <button class="btn btn-outline" onclick="changeQty(${
                i.id
              },-1)">-</button>
              ${i.qty}
              <button class="btn btn-outline" onclick="changeQty(${
                i.id
              },1)">+</button>
            </div>
            <div>${(i.pret || 0) * i.qty} lei</div>
          `;
          cartList.appendChild(row);
        });

        totalPrice.textContent = total;
        shippingNote.textContent =
          total >= 100 ? "Transport gratuit!" : "Transport 20 lei";

        localStorage.setItem("cart", JSON.stringify(cart));
      }

      function changeQty(id, delta) {
        const item = cart.find((i) => i.id === id);
        if (!item) return;
        item.qty += delta;
        if (item.qty <= 0) cart = cart.filter((i) => i.id !== id);
        updateCart();
      }

      // categorii
      document.querySelectorAll(".category").forEach((btn) =>
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".category")
            .forEach((c) => c.classList.remove("active"));
          btn.classList.add("active");

          renderProducts(
            btn.dataset.category,
            document.querySelector(".search").value
          );
        })
      );

      // search
      document.querySelector(".search").addEventListener("input", (e) => {
        const active =
          document.querySelector(".category.active").dataset.category;
        renderProducts(active, e.target.value);
      });

      // checkout -> POST order cÄƒtre backend
      document
        .getElementById("checkoutBtn")
        .addEventListener("click", async () => {
          if (cart.length === 0) {
            alert("CoÈ™ul este gol!");
            return;
          }

          const userStr = sessionStorage.getItem("petjoy_user");
          if (!userStr) {
            alert("Trebuie sÄƒ te autentifici ca sÄƒ finalizezi comanda.");
            window.location.href = "autentificare.html";
            return;
          }

          const user = JSON.parse(userStr);

          // SolicitÄƒ adresa de livrare
          const adresaLivrare = prompt("Introdu adresa de livrare:");
          if (!adresaLivrare || adresaLivrare.trim() === "") {
            alert("Adresa de livrare este obligatorie!");
            return;
          }

          const payload = {
            email: user.email,
            adresaLivrare: adresaLivrare.trim(),
            items: cart.map((c) => ({
              productId: c.id,
              quantity: c.qty,
            })),
          };

          try {
            const res = await fetch("/api/orders", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            if (!res.ok) {
              const txt = await res.text();
              alert("Eroare la plasarea comenzii: " + txt);
              return;
            }

            alert("Comanda a fost plasatÄƒ cu succes!");
            cart = [];
            updateCart();

            // reÃ®ncarcÄƒ produse (cÃ¢nd backend va merge, vei vedea stoc actualizat)
            loadProducts();

            window.location.href = "meniu.html";
          } catch (err) {
            console.error(err);
            alert("Backend indisponibil. Nu pot plasa comanda acum.");
          }
        });

      // iniÈ›ial
      updateCart();
      loadProducts();

      // VerificÄƒ starea de autentificare È™i afiÈ™eazÄƒ butonul corespunzÄƒtor
      document.addEventListener("DOMContentLoaded", function () {
        const user = sessionStorage.getItem("petjoy_user");
        const authButton = document.getElementById("authButton");
        const profileButton = document.getElementById("profileButton");

        if (user) {
          authButton.style.display = "none";
          profileButton.style.display = "block";
        } else {
          authButton.style.display = "block";
          profileButton.style.display = "none";
        }
      });
    </script>
  </body>
</html>
