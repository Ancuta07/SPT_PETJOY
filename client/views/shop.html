<!DOCTYPE html>
<html lang="ro">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Magazin Online - Clinica VeterinarƒÉ</title>
    <meta
      name="description"
      content="Magazin online cu produse pentru animale. Afi»ôare disponibilitate per magazin »ôi cumpƒÉrƒÉturi online. Transport gratuit peste 100 lei."
    />
    <link rel="stylesheet" href="../styles/shop.css" />
  </head>

  <body>
    <section class="header">
      <nav>
        <div class="nav-links">
          <ul>
            <li><a href="index.html">MENIU</a></li>
            <li><a href="despre.html">DESPRE NOI</a></li>
            <li><a href="contact.html">CONTACTE</a></li>
            <li><a href="shop.html">SHOP</a></li>
            <li id="authButton">
              <a href="autentificare.html" title="Autentificare">üîê</a>
            </li>
            <li id="profileButton" style="display: none">
              <a href="meniu.html" title="Profilul meu">üë§</a>
            </li>
          </ul>
        </div>
      </nav>
    </section>

    <div class="wrap">
      <header>
        <div class="brand">
          <div class="logo">
            <img src="../images/shop1.jpeg" />
          </div>

          <div>
            <h1>Magazin Online PetJoy</h1>
            <div class="lead">
              Transport gratuit la comenzi ‚â• <strong>100 lei</strong> ‚Ä¢ Ridicare
              din magazine disponibile: Bra»ôov ¬∑ Constan»õa ¬∑ Sibiu
            </div>
          </div>
        </div>
      </header>

      <main class="main">
        <aside class="sidebar">
          <div class="categories">
            <h3>Categorii</h3>
            <div class="category active" data-category="toate">Toate</div>
            <div class="category" data-category="uscata">M√¢ncare uscatƒÉ</div>
            <div class="category" data-category="umeda">M√¢ncare umedƒÉ</div>
            <div class="category" data-category="accesorii">Accesorii</div>
            <div class="category" data-category="asternut">
              A»ôternut igienic
            </div>
          </div>
        </aside>

        <section class="products-wrap">
          <div class="filters">
            <input type="text" class="search" placeholder="CautƒÉ produse..." />
          </div>
          <div class="grid" id="productGrid"></div>
        </section>

        <aside class="cart">
          <h3>Co»ô de cumpƒÉrƒÉturi</h3>
          <div class="cart-list" id="cartList"></div>
          <div class="total">Total: <span id="totalPrice">0</span> lei</div>
          <div class="shipping-note" id="shippingNote"></div>
          <button class="btn btn-primary" id="checkoutBtn">
            FinalizeazƒÉ comanda
          </button>
        </aside>
      </main>

      <footer>¬© 2025 Clinica VeterinarƒÉ - Toate drepturile rezervate.</footer>
    </div>

    <script>
      /**
       * FALLBACK: produse hardcodate (ca sƒÉ nu pierzi nimic).
       * DacƒÉ backend-ul nu merge / nu rƒÉspunde, le folosim pe astea.
       */
      const fallbackProducts = [
        {
          id: 1,
          categorie: "uscata",
          nume: "HranƒÉ uscatƒÉ pisici Whiskas",
          pret: 45,
          stoc: 999,
          imageUrl: "../images/w.jpeg",
          descriere: "",
        },
        {
          id: 2,
          categorie: "umeda",
          nume: "ConservƒÉ umedƒÉ Royal Canin",
          pret: 22,
          stoc: 999,
          imageUrl: "../images/conserva_royal.jpeg",
          descriere: "",
        },
        {
          id: 3,
          categorie: "accesorii",
          nume: "JucƒÉrie »ôoricel pentru pisici",
          pret: 15,
          stoc: 999,
          imageUrl: "../images/jucarie.jpeg",
          descriere: "",
        },
        {
          id: 4,
          categorie: "asternut",
          nume: "A»ôternut igienic",
          pret: 39,
          stoc: 999,
          imageUrl: "../images/nisip.jpeg",
          descriere: "",
        },
        {
          id: 5,
          categorie: "uscata",
          nume: "HranƒÉ uscatƒÉ c√¢ini Pedigree",
          pret: 110,
          stoc: 999,
          imageUrl: "../images/p.jpeg",
          descriere: "",
        },
        {
          id: 6,
          categorie: "accesorii",
          nume: "LesƒÉ reglabilƒÉ",
          pret: 49,
          stoc: 999,
          imageUrl: "../images/ham.jpeg",
          descriere: "",
        },
        {
          id: 7,
          categorie: "umeda",
          nume: "ConservƒÉ pisici",
          pret: 30,
          stoc: 999,
          imageUrl: "../images/conserva_pisici.jpeg",
          descriere: "",
        },
        {
          id: 8,
          categorie: "asternut",
          nume: "Nisip parfumat pisici",
          pret: 55,
          stoc: 999,
          imageUrl: "../images/nisip_parfumat.jpeg",
          descriere: "",
        },
      ];

      /**
       * Lista realƒÉ de produse (ideal vine din backend).
       * DacƒÉ nu reu»ôim sƒÉ √ÆncƒÉrcƒÉm din backend, punem fallbackProducts.
       */
      let products = [];

      const grid = document.getElementById("productGrid");
      const cartList = document.getElementById("cartList");
      const totalPrice = document.getElementById("totalPrice");
      const shippingNote = document.getElementById("shippingNote");

      // √Æn co»ô salvƒÉm minimul ca sƒÉ nu depindem de structura backend
      let cart = JSON.parse(localStorage.getItem("cart") || "[]");

      /**
       * √éncearcƒÉ sƒÉ ia produsele din backend.
       * DacƒÉ backend nu merge / e gol / dƒÉ eroare => fallbackProducts.
       */
      async function loadProducts() {
        try {
          const res = await fetch("http://localhost:8000/api/products");
          if (!res.ok) throw new Error("Backend error: " + res.status);

          const data = await res.json();

          // dacƒÉ backend rƒÉspunde dar e gol, folosim fallback (ca sƒÉ ai UI populat)
          if (!Array.isArray(data) || data.length === 0) {
            products = fallbackProducts;
          } else {
            products = data;
          }
        } catch (err) {
          console.warn("Backend indisponibil, folosesc fallbackProducts.", err);
          products = fallbackProducts;
        }

        const active =
          document.querySelector(".category.active")?.dataset.category ||
          "toate";
        const search = document.querySelector(".search").value;
        renderProducts(active, search);
      }

      function renderProducts(filter = "toate", search = "") {
        grid.innerHTML = "";

        const f = (filter || "toate").toLowerCase();
        const s = (search || "").toLowerCase();

        products
          .filter((p) => {
            const categorie = (p.categorie || "").toLowerCase();
            const nume = (p.nume || "").toLowerCase();

            const matchCategory = f === "toate" || categorie === f;
            const matchSearch = nume.includes(s);

            return matchCategory && matchSearch;
          })
          .forEach((p) => {
            const card = document.createElement("div");
            card.className = "card";

            const img = p.imageUrl || "../images/shop.jpeg";
            const nume = p.nume || "Produs";
            const descriere = p.descriere || "";
            const pret = p.pret ?? 0;
            const stoc = p.stoc ?? 0;

            card.innerHTML = `
              <img src="${img}" alt="${nume}" class="prod-img">
              <div class="prod-title">${nume}</div>
              ${descriere ? `<div class="prod-desc">${descriere}</div>` : ``}
              <div class="price">${pret} lei</div>
              <div class="stores">Stoc: ${stoc}</div>
              <button class="btn btn-primary" onclick="addToCart(${p.id})" ${
              stoc <= 0 ? "disabled" : ""
            }>
                ${stoc <= 0 ? "Stoc epuizat" : "AdaugƒÉ √Æn co»ô"}
              </button>
            `;

            grid.appendChild(card);
          });
      }

      function addToCart(id) {
        const prod = products.find((p) => p.id === id);
        if (!prod) return;

        if ((prod.stoc ?? 0) <= 0) {
          alert("Produsul nu mai este √Æn stoc.");
          return;
        }

        const item = cart.find((i) => i.id === id);
        if (item) {
          item.qty++;
        } else {
          cart.push({
            id: prod.id,
            nume: prod.nume,
            pret: prod.pret,
            imageUrl: prod.imageUrl,
            qty: 1,
          });
        }
        updateCart();
      }

      function updateCart() {
        cartList.innerHTML = "";
        let total = 0;

        cart.forEach((i) => {
          total += (i.pret || 0) * i.qty;

          const row = document.createElement("div");
          row.className = "cart-item";
          row.innerHTML = `
            <div>${i.nume}</div>
            <div class="qty">
              <button class="btn btn-outline" onclick="changeQty(${i.id},-1)">-</button>
              ${i.qty}
              <button class="btn btn-outline" onclick="changeQty(${i.id},1)">+</button>
            </div>
            <div>${(i.pret || 0) * i.qty} lei</div>
          `;
          cartList.appendChild(row);
        });

        totalPrice.textContent = total;
        shippingNote.textContent =
          total >= 100 ? "Transport gratuit!" : "Transport 20 lei";

        localStorage.setItem("cart", JSON.stringify(cart));
      }

      function changeQty(id, delta) {
        const item = cart.find((i) => i.id === id);
        if (!item) return;
        item.qty += delta;
        if (item.qty <= 0) cart = cart.filter((i) => i.id !== id);
        updateCart();
      }

      // categorii
      document.querySelectorAll(".category").forEach((btn) =>
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".category")
            .forEach((c) => c.classList.remove("active"));
          btn.classList.add("active");

          renderProducts(btn.dataset.category, document.querySelector(".search").value);
        })
      );

      // search
      document.querySelector(".search").addEventListener("input", (e) => {
        const active =
          document.querySelector(".category.active").dataset.category;
        renderProducts(active, e.target.value);
      });

      // checkout -> POST order cƒÉtre backend
      document.getElementById("checkoutBtn").addEventListener("click", async () => {
        if (cart.length === 0) {
          alert("Co»ôul este gol!");
          return;
        }

        const userStr = sessionStorage.getItem("petjoy_user");
        if (!userStr) {
          alert("Trebuie sƒÉ te autentifici ca sƒÉ finalizezi comanda.");
          window.location.href = "autentificare.html";
          return;
        }

        const user = JSON.parse(userStr);

        const payload = {
          email: user.email,
          items: cart.map((c) => ({
            productId: c.id,
            quantity: c.qty,
          })),
        };

        try {
          const res = await fetch("http://localhost:8000/api/orders", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            const txt = await res.text();
            alert("Eroare la plasarea comenzii: " + txt);
            return;
          }

          alert("Comanda a fost plasatƒÉ cu succes!");
          cart = [];
          updateCart();

          // re√ÆncarcƒÉ produse (c√¢nd backend va merge, vei vedea stoc actualizat)
          loadProducts();

          window.location.href = "meniu.html";
        } catch (err) {
          console.error(err);
          alert("Backend indisponibil. Nu pot plasa comanda acum.");
        }
      });

      // ini»õial
      updateCart();
      loadProducts();

      // VerificƒÉ starea de autentificare »ôi afi»ôeazƒÉ butonul corespunzƒÉtor
      document.addEventListener("DOMContentLoaded", function () {
        const user = sessionStorage.getItem("petjoy_user");
        const authButton = document.getElementById("authButton");
        const profileButton = document.getElementById("profileButton");

        if (user) {
          authButton.style.display = "none";
          profileButton.style.display = "block";
        } else {
          authButton.style.display = "block";
          profileButton.style.display = "none";
        }
      });
    </script>
  </body>
</html>
